<!-- Inline Ajax version.  Reduces templates, easier user interaction, but separates from postback symmetry -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ajax Version</title>
    <style>
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
        }
        th, td {
            padding: 5px;
        }
        a { cursor: pointer; color: blue; }
        a:hover,a.hover { text-decoration: underline; }
    </style>
</head>
<body>
<a href="/logout">Logout</a><br><br>
<div id="display"></div>

<script   src="https://code.jquery.com/jquery-2.2.3.min.js"   integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo="   crossorigin="anonymous"></script>
<script src="/scripts/ejs.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function(event) {
        loadBooks();
    });

    function loadBooks(){
        $.get('/views/books/list-full.ejs', function (template) {
            $.get('/api/books/', function(books) {
                var snippet = ejs.render(template, {books: books});
                document.getElementById('display').innerHTML = snippet;
            });
        });
    }

    function deleteBook(id, btn){
        $.ajax({
            url:'/api/books/' + id,
            type: 'DELETE',
            success: function(res) {
                var row = btn.parentNode.parentNode;
                row.parentNode.removeChild(row);
                return false;
            }
        });
    }

    function addBook(){
        var title = document.getElementById('title');
        var author = document.getElementById('author');
        var price = document.getElementById('price');
        $.ajax({
            url:'/api/books/',
            data: 'title=' + title.value + '&author=' + author.value + '&price=' + price.value,
            type: 'POST',
            success: function(res) {
                title.value = author.value = price.value = "";
                loadBooks();
            }
        });

    }

    function updateBook(id){
        var title = document.getElementById('title' + id).value;
        var author = document.getElementById('author' + id).value;
        var price = document.getElementById('price' + id).value;
        $.ajax({
            url:'/api/books/' + id,
            data: 'title=' + title + '&author=' + author + '&price=' + price,
            type: 'PUT',
            success: function(res) {
                var displayRow = $("#display" + id);
                var displayFields = displayRow.find('span');
                displayFields[0].innerHTML = title;
                displayFields[1].innerHTML = author;
                displayFields[2].innerHTML = price;
                toggleEdit(id, false);
            }
        });
    }

    function toggleEdit(index, show){
        var displayRow = document.getElementById("display" + index);
        var editRow = document.getElementById("edit" + index);
        if (show){
            displayRow.style.display = "none";
            editRow.style.display = "";
        }
        else{
            displayRow.style.display = "";
            editRow.style.display = "none";
        }
    }

    function toggleAdd(show){
        var addRow = document.getElementById("addRow");
        var btn = document.getElementById("addbutton");
        if (show){
            addRow.style.display = "";
            btn.style.display = "none";
        }
        else{
            addRow.style.display = "none";
            btn.style.display = "";
        }
    }



</script>
</body>
</html>
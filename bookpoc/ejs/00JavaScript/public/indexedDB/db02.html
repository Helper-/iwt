<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IndexedDB</title>
</head>
<body>
<div id="display"></div>
<script>

    /*  global variable used to maintain the database connection */
    var DB;

    document.addEventListener("DOMContentLoaded", function(event) {
        openDB(loadData);
    });

    /*
        Open the page's database for usage.  Added in checks for cross-browser support.
     */
     function openDB(callback){
         window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;

         window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction;
         window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange


         var request = window.indexedDB.open("cse136-1", 1);

         /*  when the database successfully opens, it will return a reference to the database
             for future actions
         */
         request.onsuccess = function(e) {
             DB = e.target.result;
             callback();
         };

         /*  This is the only place to create object stores.
             We will create our book store and specify that 'id' is the key
            This function will only be called the first time the code is run or the first time
            the version in 'open' is changed.
         */
         request.onupgradeneeded = function(e){
             var db = e.target.result;

             /*  We use autoIncrement: true for the key.  The key will be auto-generated when items are added.
                 The key will be separate from the value object.
              */
             if(!db.objectStoreNames.contains('students')) {
                 db.createObjectStore('students', { autoIncrement:true });
             }

         };

         request.onerror = function(e) {
             console.log(e);
         };

     }

    /*  Loops through all the stores and displays their name.  Also reports on database and version */
    function report(e){
        var msg = 'Database ' + DB.name + ' version ' + DB.version + ' successfully opened';
        msg += ' and holds stores:<br>';

        for (var i=0;i<DB.objectStoreNames.length;i++){
            msg += DB.objectStoreNames[i] + '<br>';
        }

        document.getElementById('display').innerHTML = msg;
    }

    /*  NEW Function to load data after the database is opened */
    function loadData(){

        /*  We are going to add the initial data to the students store */
        var initialData = [
            {first: 'Ali', last: 'Sorenson', age:20, hometown: 'San Francisco', gender: 'F'},
            {first: 'Keira', last: 'Sorenson', age:19, hometown: 'San Francisco', gender: 'F' },
            {first: 'Gavin', last: 'Birmingham', age:21, hometown: 'San Diego', gender:'M' },
            {first: 'Evy', last: 'Grant', age:20, hometown: 'New York', gender:'F' }
        ];

        /*  Open a transaction for modifying the students store.
         We will see in future examples that you can pass multiple stores in the form of an array.
         We can also chain together a few lines.  */
        var trans = DB.transaction('students', 'readwrite');

        /* Get reference to the students store */
        var studentStore = trans.objectStore('students');

        /*  Since we are adding more than one row, we need to make sure we don't call our report function until
         all rows are successfully added.  We will keep track of the success calls and once we have all of
         them, we'll call the report function */

        var numRequests = initialData.length;

        for (var i=0;i<initialData.length;i++) {
            var request = studentStore.add(initialData[i]);

            /*  Keep track of the number of requests so that we only call report after all have been added */
            request.onsuccess = function(){
                if (--numRequests === 0){
                    report();
                }
            };
        }
    }




</script>
</body>
</html>
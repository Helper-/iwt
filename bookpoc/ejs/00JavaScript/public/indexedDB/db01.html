<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IndexedDB</title>
    <style>
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
        }
        th, td {
            padding: 5px;
        }
        a { cursor: pointer; color: blue; }
        a:hover,a.hover { text-decoration: underline; }
    </style>
</head>
<body>
<div id="display"></div>
<!-- Only using jquery for Ajax calls.  Consider changing to native -->
<script   src="https://code.jquery.com/jquery-2.2.3.min.js"   integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo="   crossorigin="anonymous"></script>
<script src="/scripts/ejs.min.js"></script>
<script>
    /*  Using Global Scope. Very bad.  If interacting with other scripts, must namespace/modulerize */

    /* Script contents should be in external file, but kept in here for demo purposes */

    document.addEventListener("DOMContentLoaded", function(event) {
        openDB(load);
    });

    /*  global variable used to maintain the database connection */
    var bookDB;

    /*
        Open the page's database for usage.  Added in checks for cross-browser support.
     */
     function openDB(callback){
         window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;

         window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction;
         window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange

         /* Here we open the database called cse136.
            We will add the book store to it soon
            The '1' indicates the version of the database.  Anytime
            we change it or add a store, we need to increase the version.
         */
         var request = window.indexedDB.open("cse136", 1);

         request.onsuccess = function(e) {
             bookDB = e.target.result;
             callback();
         };

         /*  This is the only place to create object stores.
             We will create our book store and specify that 'id' is the key
            This function will only be called the first time the code is run or the first time
            the version in 'open' is changed.
         */
         request.onupgradeneeded = function(e){
             var db = e.target.result;

             if(!db.objectStoreNames.contains('books')) {
                 db.createObjectStore('books', { autoIncrement:true });
             }
         };

         request.onerror = function(e) {
             console.log(e);
         };

     }

     /**
      *   Gets the count of items in the books store and then adds the initial data if nothing is in the store.
      */
     function load(){
         var initialData = [{title:"The Alloy of Law",author:"Brandon Sanderson",publisher:"Tor Books ",price:20},{title:"The Queen of the Tearling",author:"Erika Johansen",publisher:"Harper",price:9.51},{title:"Truthwitch",author:"Susan Dennard",publisher:"Tor Books",price:9.99}];
         var store = bookDB.transaction(['books'], 'readwrite').objectStore('books');
         var count = store.count();

         count.onsuccess = function() {
             /*  If the count is 0, we need to add the initial data */
             if (count.result === 0){
                 var numRequests = initialData.length;

                 for (var i=0;i<initialData.length;i++) {
                     var request = store.add(initialData[i]);

                     /*  Keep track of the number of requests so that we only call loadList after all have been added*/
                     request.onsuccess = function(){
                        if (--numRequests === 0){
                            loadList();
                        }
                     }
                 }
             }
             else{
                //We don't need to preload data, so call loadList immediately */
                loadList();
             }
         }
     }


    /*  variable used to store templates in a cache to prevent multiple requests on static file */
    var templatesCache = [];

    /**
     *   Checks if template exists in the cache.  If so, calls displayTemplate.
     *   If not, first loads template and adds it to cache before calling displayTemplate.
     */
    function loadTemplate(name, data) {
        /* Check template cache to see if template has been loaded.  If so, immediately call displayTemplate() */
        if (templatesCache[name]) {
            displayTemplate(templatesCache[name], data);
        }
        else {
            /* If template is not in cache, use Ajax to fetch template, then store in cache and call displayTemplate() */
            $.get('/views/books/' + name + '.ejs', function(template) {
                templatesCache[name] = template;
                displayTemplate(template, data);
            });
        }
    }

    /**
     * Takes template string and data and uses EJS to render them together.
     * Then displays the new HTML inside of the display div.
     */
    function displayTemplate(template, data) {
        var snippet = ejs.render(template, data);
        document.getElementById('display').innerHTML = snippet;
    }

    /**
     *  Gets the data from the store and then loads the template with the given data.
     */
    function loadList() {
        var store = bookDB.transaction(['books']).objectStore('books');
        var bookList = [];

        store.openCursor().onsuccess = function(event) {
            var cursor = event.target.result;

            if (cursor) {
                var book = cursor.value;
                book['id'] = cursor.key;
                bookList.push(book);
                cursor.continue();
            }
            else{
                //This means we have finished looping through the records.
                loadTemplate('list-full', {books: bookList});
            }
        };
    }

    /**
     *  Displays the confirm delete page for the passed in book.
     */
    function confirmDelete(id) {
        var title = document.getElementById('title' + id).innerHTML;
        var book = {id: id, title: title};

        loadTemplate('delete', {book: book});
    }

    /**
     *  Removes the book from the store.
     */
    function deleteBook(id) {
        var store = bookDB.transaction(['books'], 'readwrite').objectStore('books');
        var request = store.delete(id);
        request.onsuccess = loadList;
    }

    /**
     *  Displays the add book page.
     */
    function showAdd() {
        loadTemplate('add');
    }

    /**
     *  Adds the book to the store
     */
    function addBook() {
        var title = document.getElementById('title');
        var author = document.getElementById('author');
        var price = document.getElementById('price');
        var book = {title: title.value, author: author.value, price: price.value};

        var store = bookDB.transaction(['books'], 'readwrite').objectStore('books');
        var request = store.add(book);

        request.onsuccess = loadList;
    }

    /**
     *  Displays the edit book page for the passed in book.
     */
    function showEdit(id) {
        var title = document.getElementById('title' + id).innerHTML;
        var author = document.getElementById('author' + id).innerHTML;
        var price = document.getElementById('price' + id).innerHTML;
        var book = {id: id, title: title, author: author, price: price};
        loadTemplate('edit', {book: book});
    }

    /**
     *  Updates the record in the store
     */
    function updateBook(id) {
        var title = document.getElementById('edittitle' + id);
        var author = document.getElementById('editauthor' + id);
        var price = document.getElementById('editprice' + id);
        var book = {title: title.value, author: author.value, price: price.value};

        var store = bookDB.transaction(['books'], 'readwrite').objectStore('books');
        var request = store.put(book, id);

        request.onsuccess = loadList;
    }

</script>
</body>
</html>
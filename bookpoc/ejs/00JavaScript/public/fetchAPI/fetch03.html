<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fetch</title>
    <style>
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
        }
        th, td {
            padding: 5px;
        }
        a { cursor: pointer; color: blue; }
        a:hover,a.hover { text-decoration: underline; }
    </style>
</head>
<body>
<div id="display"></div>
<script src="/scripts/ejs.min.js"></script>
<script>

    document.addEventListener("DOMContentLoaded", function(event) {
        loadBooks();
    });


    /*  In this example, we will show how to handle errors.
        We will load a page that does not exist
        so we receive a 404.

         NOTE:  The fetch returning a 404 DOES NOT automatically go to the .catch.
                From the API:
                'API only rejects a promise when a “network error is encountered, although this usually means permissions issues or similar.”'

     */
    function loadBooks() {
        var bookList;
        fetch('/api/booklist/')
        .then(handleErrors)
        .then( function(response) {
            return response.json();
        }).then(function(books){
            bookList = books;
            return fetch('/views/books/list.ejs');
        })
        .then(handleErrors)
        .then (function(response) {
            return response.text();
        }).then(function(template){
            var snippet = ejs.render(template, {books: bookList});
            document.getElementById('display').innerHTML = snippet;
        }).catch(function(err) {
            var msg = 'Cannot load data: ' + err;
            document.getElementById('display').innerHTML = msg;
        });

    }

    /*  Generic handleErrors page to check if the request is valid.  We call it after each of our fetch calls.
        We must check the response.ok flag to see if it was valid and then check the response.status/statusText to
        see what the status is.
     */
    function handleErrors(response){
        if (response.ok){
            return response;
        }
        else{
            throw Error(response.status + ' - ' + response.statusText + ': ' + response.url);
        }
    }


</script>
</body>
</html>
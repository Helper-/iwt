<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IndexedDB</title>
</head>
<body>
<div id="display"></div>
<script>
    /*  Using Global Scope. Very bad.  If interacting with other scripts, must namespace/modulerize */

    /* Script contents should be in external file, but kept in here for demo purposes */

    document.addEventListener("DOMContentLoaded", function(event) {
        openDB(report);
    });


    /*  global variable used to maintain the database connection */
    var DB;

    /*
        Open the page's database for usage.  Added in checks for cross-browser support.
     */
     function openDB(callback){
         window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;

         window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction;
         window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange

         /* Here we open the database called cse136.
            The '1' indicates the version of the database.  Anytime
            we change it or add a store, we need to increase the version.
         */
         var request = window.indexedDB.open("cse136-1", 1);

         /*  when the database successfully opens, it will return a reference to the database
             for future actions
         */
         request.onsuccess = function(e) {
             DB = e.target.result;
             callback();
         };

         /*  This is the only place to create object stores.
             We will create our book store and specify that 'id' is the key
            This function will only be called the first time the code is run or the first time
            the version in 'open' is changed.
         */
         request.onupgradeneeded = function(e){
             var db = e.target.result;

             /*  We use autoIncrement: true for the key.  The key will be auto-generated when items are added.
                 The key will be separate from the value object.
              */
             if(!db.objectStoreNames.contains('students')) {
                 db.createObjectStore('students', { autoIncrement:true });
             }
         };

         request.onerror = function(e) {
             console.log(e);
         };

     }

    /*  Loops through all the stores and displays their name.  Also reports on database and version */
    function report(e){
        var msg = 'Database ' + DB.name + ' version ' + DB.version + ' successfully opened';
        msg += ' and holds stores:<br>';

        for (var i=0;i<DB.objectStoreNames.length;i++){
            msg += DB.objectStoreNames[i] + '<br>';
        }

        document.getElementById('display').innerHTML = msg;
        console.log(DB);
    }


</script>
</body>
</html>
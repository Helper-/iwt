<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IndexedDB</title>
</head>
<body>
<div id="display"></div>
<!-- NEW:  Delete All button.  Don't worry, if you delete all, the next time you run page, it'll reload the data -->
<button onclick="deleteAll();">Delete All</button>
<script>

    /*  global variable used to maintain the database connection */
    var DB;

    document.addEventListener("DOMContentLoaded", function(event) {
        openDB(loadData);
    });

    /*
        Open the page's database for usage.  Added in checks for cross-browser support.
     */
     function openDB(callback){
         window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;

         window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction;
         window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange


         var request = window.indexedDB.open("cse136-1", 1);

         /*  when the database successfully opens, it will return a reference to the database
             for future actions
         */
         request.onsuccess = function(e) {
             DB = e.target.result;
             callback();
         };

         /*  This is the only place to create object stores.
             We will create our book store and specify that 'id' is the key
            This function will only be called the first time the code is run or the first time
            the version in 'open' is changed.
         */
         request.onupgradeneeded = function(e){
             var db = e.target.result;

             /*  We use autoIncrement: true for the key.  The key will be auto-generated when items are added.
                 The key will be separate from the value object.
              */
             if(!db.objectStoreNames.contains('students')) {
                 db.createObjectStore('students', { autoIncrement:true });
             }

         };

         request.onerror = function(e) {
             console.log(e);
         };

     }

    function loadData(){

        /*  We are going to change the adding of initial data to ONLY add if there is no current data.
         We can also add initial data when we create the store as we will see in future examples
         We use the .count method on the store to see if there is any data yet.  */

        /*  We are going to add the initial data to the students store */
        var initialData = [
            {first: 'Ali', last: 'Sorenson', age:20, hometown: 'San Francisco', gender: 'F'},
            {first: 'Keira', last: 'Sorenson', age:19, hometown: 'San Francisco', gender: 'F' },
            {first: 'Gavin', last: 'Birmingham', age:21, hometown: 'San Diego', gender:'M' },
            {first: 'Evy', last: 'Grant', age:20, hometown: 'New York', gender:'F' }
        ];

        /*  Open a transaction for modifying the students store.
         We will see in future examples that you can pass multiple stores in the form of an array.
         We can also chain together a few lines.  */
        var trans = DB.transaction('students', 'readwrite');

        /* Get reference to the students store */
        var studentStore = trans.objectStore('students');

        /*  Check the count of the store */
        var count = studentStore.count();
        var msg = 'Database ' + DB.name + ' version ' + DB.version + ' successfully opened.';

        count.onsuccess = function() {

            /* Only add the data if the count is 0 */
            if (count.result === 0) {
                /*  Since we are adding more than one row, we need to make sure we don't call our report function until
                 all rows are successfully added.  We will keep track of the success calls and once we have all of
                 them, we'll call the report function */

                var numRequests = initialData.length;

                for (var i= 0; i< initialData.length; i++) {
                    var request = studentStore.add(initialData[i]);

                    /*  Keep track of the number of requests so that we only call report after all have been added */
                    request.onsuccess = function(){
                        if (--numRequests === 0){
                            report(msg);
                        }
                    };
                }
            }
            else{
                /* If data is already added, just call report() */
                report(msg);
            }
        };
    }

    /*  NEW: simplified report for single store.  Combo of report from db03 and db04 */
    function report(msg){

        /* Open up the store.  We will chain the transaction and objectStore request together */
        var studentStore = DB.transaction('students').objectStore('students');

        msg += '<h3>Student Records:</h3><ul>';

        /*  We need the key for the delete, so we'll use the cursor method */
        studentStore.openCursor().onsuccess = function(event) {
            var cursor = event.target.result;

            /*  If cursor exists, we have a record.  If it does not exist, it means we reached the last row
             Added in link to delete the record  */
            if (cursor) {
                msg += '<li>' + cursor.key + ': ' + JSON.stringify(cursor.value);
                msg += ' <button onclick="updateRow(' + cursor.key + ');">Update</button>';
                msg += ' <button onclick="deleteRow(' + cursor.key + ');">Delete</button>';
                msg += '</li>';
                cursor.continue();
            }
            else {
                /* This means we have finished looping through the records so it's time to output the data */
                msg += '</ul>';
                document.getElementById('display').innerHTML = msg;
            }
        };

    }

    /*  NEW: Deletes all items in the store using the clear() method and then calls report again */
    function deleteAll(){
        var studentStore = DB.transaction('students', 'readwrite').objectStore('students');
        studentStore.clear().onsuccess = function(){
            report('All rows successfully removed from Student Store.');
        };
    }

    /*  NEW: Deletes single row from the store based on the passed in key ID */
    function deleteRow(id){
        var studentStore = DB.transaction('students', 'readwrite').objectStore('students');
        studentStore.delete(id).onsuccess = function(){
            report(id + ' successfully removed from Student Store.');
        };
    }

    /*  NEW: Updates single row from the store based on the passed in key ID.
        For this example, we are hard-coding edits  */
    function updateRow(id, row){
        var studentStore = DB.transaction('students', 'readwrite').objectStore('students');

        /*  We have to fetch the row from the db.  Depending on actual implementation, you may
            already have the row so you wouldn't need the double access */
        studentStore.get(id).onsuccess = function(e) {
            var row = e.target.result;

            /*  Now we update the value of the row.  We can also add field to the object if desired. */
            row.editedField = Math.floor(Math.random() * 100);
            /*  Note that id comes after the row.  This is because if we had a key based on the object, we would not
                need to pass the id in. */
            studentStore.put(row, id).onsuccess = function(){
                report(id + ' successfully updated in Student Store.');
            };
        };
    }


</script>
</body>
</html>
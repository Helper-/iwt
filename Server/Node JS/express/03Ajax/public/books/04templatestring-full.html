<!--  Attempt #3 (Template String) at trying to remove unnecessary fetch of in page template. -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ajax Version</title>
    <style>
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
        }
        th, td {
            padding: 5px;
        }
        a { cursor: pointer; color: blue; }
        a:hover,a.hover { text-decoration: underline; }
    </style>
</head>
<body>
<div id="display"></div>

<script   src="https://code.jquery.com/jquery-2.2.3.min.js"   integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo="   crossorigin="anonymous"></script>
<script>
    document.addEventListener("DOMContentLoaded", function(event) {
        loadBooks();
    });

    function loadBooks(){
        $.get('/api/books/', function(books) {
            document.getElementById('display').innerHTML = (listTpl(books));
        });

    }

    /*YUCK.  New way mixes html into javascript.  Ugly and difficult to maintain */
    function listTpl(books){
        return `
            <table>
                <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Author</th>
                    <th>Price</th>
                    <th></th>
                </tr>
                ${books.map(function(book){
                return `
                    <tr id='display${ book.id }'>
                        <td>${ book.id }</td>
                        <td><span>${ book.title }</span></td>
                        <td><span>${ book.author }</span></td>
                        <td>$<span>${ book.price }</span></td>
                        <td><a onClick="deleteBook(${ book.id }, this);"><img src='/images/trash.gif' alt='delete' title='Delete' border='0'></a>
                            &nbsp;<a onClick="toggleEdit(${ book.id }, true);"><img src='/images/pencil.gif' alt='edit' title='Edit' border='0'></a>
                        </td>
                    </tr>
                    <tr id='edit${ book.id }' style='display:none'>
                        <td>${ book.id }</td>
                        <td><input type="text" id="title${ book.id }"  value="${ book.title }" ></td>
                        <td><input type="text" id="author${ book.id }" value="${ book.author }"></td>
                        <td><input type="text" id="price${ book.id }" value="${ book.price }"></td>
                        <td class='recordcontrol'>
                            <a href='javascript:updateBook(${ book.id })'><img src='/images/save.gif' alt='save' title='Save Record' border='0'></a>
                            &nbsp;
                            <a href='javascript:toggleEdit(${ book.id }, false)'><img src='/images/cancel.gif' alt='cancel' title='Cancel Edit' border='0'></a>
                        </td>
                    </tr>
        
                    `}).join('')
                }
                <tr id="addRow" style="display:none">
                    <form method='post'>
                        <td>&nbsp;</td>
                        <td><input type="text" id="title"  value="" ></td>
                        <td><input type="text" id="author" value=""></td>
                        <td><input type="text" id="price" value=""></td>
                        <td class='recordcontrol'>
                            <a href='javascript:addBook();'><img src='/images/save.gif' alt='save' title='Save Record' border='0'></a>
                            &nbsp;
                            <a href='javascript:toggleAdd(0);'><img src='/images/cancel.gif' alt='cancel' title='Cancel Edit' border='0' /></a>
                        </td>
                    </form>
                </tr>
            </table>
            <br>
            <button id="addbutton" value="Add" onclick="toggleAdd(1);">Add</button>
        `;

    }

    function deleteBook(id, btn){

        $.ajax({
            url:'/api/books/' + id,
            type: 'DELETE',
            success: function(res) {
                var row = btn.parentNode.parentNode;
                row.parentNode.removeChild(row);
                return false;
            }
        });
    }

    function addBook(){
        var title = document.getElementById('title');
        var author = document.getElementById('author');
        var price = document.getElementById('price');
        $.ajax({
            url:'/api/books/',
            data: 'title=' + title.value + '&author=' + author.value + '&price=' + price.value,
            type: 'POST',
            success: function(res) {
                title.value = author.value = price.value = "";
                loadBooks();
            }
        });

    }

    function updateBook(id){
        var title = document.getElementById('title' + id).value;
        var author = document.getElementById('author' + id).value;
        var price = document.getElementById('price' + id).value;
        $.ajax({
            url:'/api/books/' + id,
            data: 'title=' + title + '&author=' + author + '&price=' + price,
            type: 'PUT',
            success: function(res) {
                var displayRow = $("#display" + id);
                var displayFields = displayRow.find('span');
                displayFields[0].innerHTML = title;
                displayFields[1].innerHTML = author;
                displayFields[2].innerHTML = price;
                toggleEdit(id, false);
            }
        });
    }

    function toggleEdit(index, show){
        var displayRow = document.getElementById("display" + index);
        var editRow = document.getElementById("edit" + index);
        if (show){
            displayRow.style.display = "none";
            editRow.style.display = "";
        }
        else{
            displayRow.style.display = "";
            editRow.style.display = "none";
        }
    }

    function toggleAdd(show){
        var addRow = document.getElementById("addRow");
        var btn = document.getElementById("addbutton");
        if (show){
            addRow.style.display = "";
            btn.style.display = "none";
        }
        else{
            addRow.style.display = "none";
            btn.style.display = "";
        }
    }

</script>

</body>
</html>